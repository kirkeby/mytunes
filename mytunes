#!/usr/bin/env python

import os
import sys
import logging
import socket
import asyncore
from threading import Thread

from library import MusicLibrary
from player import Player
from moc import MocClient
from moc import AsyncoreMocProtocol
from console import run_console

def main(library_path):
    library = MusicLibrary()
    library.open(library_path)
    player = Player(library)

    protocol = AsyncoreMocProtocol()
    client = MocClient(protocol, player)
    protocol.client = client
    player.client = client

    protocol.create_socket(socket.AF_UNIX, socket.SOCK_STREAM)
    protocol.connect('/home/sune/.moc/socket2')

    
    try:
        context = locals().copy()
        del context['library_path']
        context['running'] = True

        Thread(target=run_console, name='Console', args=(context,)).start()
        asyncore.loop()

    finally:
        context['running'] = False

if __name__ == '__main__':
    logging.basicConfig(level=0)
    logging.getLogger().setLevel(0)

    from commands import getoutput
    if not getoutput('pgrep mocp').strip():
        os.system('mocp -S')

    main(os.path.expanduser('~/.mytunes'))
